<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logística Integrada</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React e ReactDOM (Versões de Produção) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Ajustes específicos para impressão */
        @media print {
            @page { margin: 1.5cm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .print-hidden { display: none !important; }
            .print-shadow-none { box-shadow: none !important; }
            .print-border { border: 1px solid #ddd !important; }
            .print-w-full { width: 100% !important; max-width: none !important; }
            .print-pb-0 { padding-bottom: 0 !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURAÇÃO DO BANCO DE DADOS ---
        const DB_ID = '642598732497662e240a'; 
        const API_URL = `https://api.npoint.io/${DB_ID}`;

        // --- HELPER DE RENDERIZAÇÃO SEGURA ---
        const safeRender = (val) => {
            if (val === null || val === undefined) return '';
            if (typeof val === 'string' || typeof val === 'number') return val;
            return ''; 
        };

        // --- SISTEMA DE ÍCONES (SVG NATIVO) ---
        const IconBase = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );

        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Truck = (props) => <IconBase {...props}><path d="M10 17h4"/><path d="M20 17h2v-2a1 1 0 0 0-1-1h-5"/><path d="M9 17h1"/><path d="M5 17h.01"/><path d="M2 17h2"/><path d="M15 17h1"/><path d="M22 17v-5l-2-2h-3"/><rect x="2" y="5" width="13" height="10" rx="2"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Package = (props) => <IconBase {...props}><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></IconBase>;
        const FileSpreadsheet = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>;
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;

        // --- COMPONENTE DE NOTIFICAÇÃO (TOAST) ---
        const Toast = ({ id, message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(() => onClose(id), 3000);
                return () => clearTimeout(timer);
            }, [id, onClose]);

            const styles = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };

            let IconComponent = User;
            if (type === 'success') IconComponent = CheckCircle;
            if (type === 'error') IconComponent = AlertTriangle;

            return (
                <div className={`flex items-center gap-3 px-6 py-4 rounded-lg shadow-xl text-white min-w-[300px] transition-opacity duration-300 ${styles[type] || styles.info}`}>
                    <IconComponent className="w-5 h-5" />
                    <span className="font-medium text-sm">{safeRender(message)}</span>
                    <button onClick={() => onClose(id)} className="ml-auto hover:opacity-80"><X className="w-4 h-4" /></button>
                </div>
            );
        };

        // --- APLICAÇÃO PRINCIPAL ---
        function App() {
            // --- ESTADOS ---
            const [batches, setBatches] = useState([]);
            const [criticalBatches, setCriticalBatches] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [toasts, setToasts] = useState([]);
            
            // Controle de Salvamento (Correção do "Sumir do Nada")
            const isSaving = useRef(false);

            // Estados de Formulário
            const [newBatchId, setNewBatchId] = useState('');
            const [batchType, setBatchType] = useState('LM');

            // Estados de Filtro e Busca
            const [filterStatus, setFilterStatus] = useState('pending'); 
            const [searchTerm, setSearchTerm] = useState('');

            // Estados de Modal
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedBatch, setSelectedBatch] = useState(null);
            const [dispatcherName, setDispatcherName] = useState('');

            // --- FUNÇÕES AUXILIARES ---

            const playSound = () => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    
                    const ctx = new AudioContext();
                    if (ctx.state === 'suspended') ctx.resume();

                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    const now = ctx.currentTime;
                    osc.type = 'square';
                    
                    // Bip duplo
                    osc.frequency.setValueAtTime(880, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.setValueAtTime(0.01, now + 0.1);

                    osc.frequency.setValueAtTime(440, now + 0.15);
                    gain.gain.setValueAtTime(0.1, now + 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);

                    osc.start(now);
                    osc.stop(now + 0.6);
                } catch (e) {
                    console.warn("Áudio bloqueado", e);
                }
            };

            const addToast = (message, type = 'info') => {
                setToasts(prev => [...prev, { id: Date.now(), message: safeRender(message), type }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            const formatDate = (isoString) => {
                if (!isoString || typeof isoString !== 'string') return '--/--/---- --:--';
                return new Date(isoString).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });
            };

            // --- API ---

            const fetchData = async (silent = false) => {
                // Se estiver salvando, não busca dados novos para evitar sobreposição
                if (isSaving.current) return;

                if (!silent) setIsLoading(true);
                try {
                    // Headers anti-cache agressivos
                    const headers = { 
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    };
                    // Adiciona timestamp para evitar cache do navegador/servidor
                    const res = await fetch(`${API_URL}?_t=${Date.now()}`, { headers });
                    if (res.ok) {
                        let data = await res.json();
                        if (!Array.isArray(data)) data = [];
                        data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        setBatches(data);
                        checkCriticalBatches(data);
                    }
                } catch (error) {
                    console.error("Erro busca:", error);
                    if (!silent) addToast("Falha na conexão.", "error");
                } finally {
                    if (!silent) setIsLoading(false);
                }
            };

            const syncData = async (newData) => {
                isSaving.current = true; // Bloqueia atualizações externas
                setIsLoading(true);
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify(newData)
                    });
                    setBatches(newData); // Atualiza tela imediatamente
                    checkCriticalBatches(newData);
                    return true;
                } catch (error) {
                    console.error("Erro salvamento:", error);
                    addToast("Erro ao salvar.", "error");
                    return false;
                } finally {
                    setIsLoading(false);
                    // Aumentado para 5s para garantir que o cache do npoint limpe
                    setTimeout(() => { isSaving.current = false; }, 5000);
                }
            };

            // --- LÓGICA DE NEGÓCIO ---

            const checkCriticalBatches = (data) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                const critical = data.filter(item => {
                    if (item.status !== 'pending') return false;
                    if (!item.createdAt) return false;
                    const createdDate = new Date(item.createdAt);
                    return createdDate < today; 
                });

                setCriticalBatches(critical);
            };

            useEffect(() => {
                fetchData(true);
                const interval = setInterval(() => fetchData(true), 5000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (criticalBatches.length > 0) {
                    const soundInterval = setInterval(playSound, 10000);
                    return () => clearInterval(soundInterval);
                }
            }, [criticalBatches.length]);

            // --- HANDLERS ---

            const handleAddBatch = async (e) => {
                e.preventDefault();
                if (!newBatchId.trim()) return;

                try {
                    // Busca dados frescos com bypass de cache
                    const headers = { 'Cache-Control': 'no-cache' };
                    const res = await fetch(`${API_URL}?_t=${Date.now()}`, { headers });
                    const rawData = await res.json();
                    const currentData = Array.isArray(rawData) ? rawData : [];
                    
                    const newBatch = {
                        id: Date.now().toString(),
                        code: newBatchId.toUpperCase(),
                        type: batchType,
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        dispatchedAt: null,
                        dispatchedBy: null
                    };

                    const success = await syncData([newBatch, ...currentData]);
                    if (success) {
                        setNewBatchId('');
                        addToast("Lote emitido!", "success");
                    }
                } catch (error) {
                    console.error(error);
                    addToast("Erro ao sincronizar.", "error");
                }
            };

            const handleDispatch = async (e) => {
                e.preventDefault();
                if (!selectedBatch || !dispatcherName.trim()) return;

                try {
                    const headers = { 'Cache-Control': 'no-cache' };
                    const res = await fetch(`${API_URL}?_t=${Date.now()}`, { headers });
                    const rawData = await res.json();
                    const currentData = Array.isArray(rawData) ? rawData : [];

                    const updatedList = currentData.map(item => {
                        if (item.id === selectedBatch.id) {
                            return {
                                ...item,
                                status: 'dispatched',
                                dispatchedAt: new Date().toISOString(),
                                dispatchedBy: dispatcherName.toUpperCase()
                            };
                        }
                        return item;
                    });

                    const success = await syncData(updatedList);
                    if (success) {
                        addToast("Lote expedido!", "success");
                        setIsModalOpen(false);
                        setDispatcherName('');
                        setSelectedBatch(null);
                    }
                } catch (error) {
                    addToast("Erro ao expedir.", "error");
                }
            };

            // NOVA FUNÇÃO: CANCELAR LOTE
            const handleCancel = async (batch) => {
                if (!window.confirm(`Deseja realmente CANCELAR o lote ${batch.code}?`)) return;

                try {
                    const headers = { 'Cache-Control': 'no-cache' };
                    const res = await fetch(`${API_URL}?_t=${Date.now()}`, { headers });
                    const rawData = await res.json();
                    const currentData = Array.isArray(rawData) ? rawData : [];

                    const updatedList = currentData.map(item => {
                        if (item.id === batch.id) {
                            return {
                                ...item,
                                status: 'cancelled',
                                dispatchedAt: new Date().toISOString() // Data do cancelamento
                            };
                        }
                        return item;
                    });

                    const success = await syncData(updatedList);
                    if (success) {
                        addToast("Lote cancelado!", "info");
                    }
                } catch (error) {
                    addToast("Erro ao cancelar.", "error");
                }
            };

            const handleDelete = async (id) => {
                if (window.confirm("Excluir este registro permanentemente?")) {
                    try {
                        const headers = { 'Cache-Control': 'no-cache' };
                        const res = await fetch(`${API_URL}?_t=${Date.now()}`, { headers });
                        const rawData = await res.json();
                        const currentData = Array.isArray(rawData) ? rawData : [];
                        
                        const updatedList = currentData.filter(item => item.id !== id);
                        const success = await syncData(updatedList);
                        if (success) addToast("Removido.", "info");
                    } catch (error) {
                        addToast("Erro ao excluir.", "error");
                    }
                }
            };

            const handleExport = () => {
                let csv = "data:text/csv;charset=utf-8,ID;TIPO;STATUS;CRIADO EM;EXPEDIDO EM;RESPONSAVEL\n";
                filteredBatches.forEach(b => {
                    const statusMap = {
                        'pending': 'PENDENTE',
                        'dispatched': 'EXPEDIDO',
                        'cancelled': 'CANCELADO'
                    };
                    const line = [
                        safeRender(b.code),
                        safeRender(b.type),
                        statusMap[b.status] || 'DESCONHECIDO',
                        formatDate(b.createdAt),
                        formatDate(b.dispatchedAt),
                        safeRender(b.dispatchedBy) || '-'
                    ].join(";");
                    csv += line + "\n";
                });
                const encodedUri = encodeURI(csv);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `logistica_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const filteredBatches = batches.filter(batch => {
                const matchesSearch = batch.code?.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesFilter = filterStatus === 'all' ? true : batch.status === filterStatus;
                return matchesSearch && matchesFilter;
            });

            const pendingCount = batches.filter(b => b.status === 'pending').length;

            return (
                <div className="pb-20 print-pb-0">
                    <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2 print-hidden pointer-events-none">
                        <div className="pointer-events-auto flex flex-col gap-2">
                        {toasts.map(t => (
                            <Toast key={t.id} id={t.id} message={t.message} type={t.type} onClose={removeToast} />
                        ))}
                        </div>
                    </div>

                    {criticalBatches.length > 0 && (
                        <div className="sticky top-0 z-50 bg-red-600 text-white p-3 shadow-md flex justify-center items-center gap-3 animate-pulse print-hidden">
                        <Volume2 className="w-6 h-6 animate-bounce" />
                        <div className="text-center font-bold">
                            ATENÇÃO: Existem {safeRender(criticalBatches.length)} lote(s) do dia anterior pendentes!
                        </div>
                        <button onClick={playSound} className="ml-2 bg-red-800 px-3 py-1 rounded text-xs hover:bg-red-900 border border-red-400 font-bold transition-colors">
                            Testar Som / Ativar
                        </button>
                        </div>
                    )}

                    <header className="bg-blue-900 text-white p-4 shadow-lg print-hidden">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-yellow-400 p-2 rounded-lg text-blue-900"><Truck className="w-6 h-6" /></div>
                            <div>
                                <h1 className="text-2xl font-bold leading-none">Logística Integrada</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className={`w-2 h-2 rounded-full ${isLoading ? 'bg-yellow-400 animate-pulse' : 'bg-green-400'}`}></span>
                                    <span className="text-xs text-blue-200 uppercase tracking-wider">{isLoading ? 'Sincronizando...' : 'Online'}</span>
                                </div>
                            </div>
                        </div>
                        <div className={`px-6 py-2 rounded-lg flex items-center gap-3 ${pendingCount > 0 ? 'bg-red-600 shadow-lg shadow-red-900/20' : 'bg-green-600 shadow-lg shadow-green-900/20'}`}>
                            <span className="text-3xl font-bold">{safeRender(pendingCount)}</span>
                            <div className="flex flex-col text-xs font-semibold uppercase leading-tight"><span>Lotes</span><span>Pendentes</span></div>
                        </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 print-w-full">
                        <div className="bg-white rounded-xl shadow-md p-6 mb-6 border-l-4 border-blue-600 print-hidden">
                        <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><Package className="w-5 h-5 text-blue-600" /> Nova Emissão</h2>
                        <form onSubmit={handleAddBatch} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full">
                                <label className="block text-sm font-semibold text-slate-500 mb-1">Número do Lote / NF</label>
                                <input autoFocus value={newBatchId} onChange={e => setNewBatchId(e.target.value)} placeholder="Ex: 12345ABC" className="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-lg uppercase" />
                            </div>
                            <div className="w-full md:w-auto">
                                <label className="block text-sm font-semibold text-slate-500 mb-1">Tipo</label>
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button type="button" onClick={() => setBatchType('LM')} className={`px-6 py-2 rounded-md font-bold text-sm transition-all ${batchType === 'LM' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}>LM</button>
                                    <button type="button" onClick={() => setBatchType('BRE')} className={`px-6 py-2 rounded-md font-bold text-sm transition-all ${batchType === 'BRE' ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}>BRE</button>
                                </div>
                            </div>
                            <button type="submit" disabled={!newBatchId.trim() || isLoading} className="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-bold rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                                {isLoading ? <RefreshCw className="w-5 h-5 animate-spin" /> : <Plus className="w-5 h-5" />} EMITIR
                            </button>
                        </form>
                        </div>

                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 print-hidden">
                            <div className="flex bg-white p-1 rounded-lg shadow-sm border border-slate-200">
                                <button onClick={() => setFilterStatus('pending')} className={`px-4 py-2 rounded-md text-sm font-bold transition-colors ${filterStatus === 'pending' ? 'bg-red-100 text-red-700' : 'text-slate-500 hover:bg-slate-50'}`}>Pendentes</button>
                                <button onClick={() => setFilterStatus('dispatched')} className={`px-4 py-2 rounded-md text-sm font-bold transition-colors ${filterStatus === 'dispatched' ? 'bg-green-100 text-green-700' : 'text-slate-500 hover:bg-slate-50'}`}>Expedidos</button>
                                <button onClick={() => setFilterStatus('cancelled')} className={`px-4 py-2 rounded-md text-sm font-bold transition-colors ${filterStatus === 'cancelled' ? 'bg-gray-100 text-gray-700' : 'text-slate-500 hover:bg-slate-50'}`}>Cancelados</button>
                                <button onClick={() => setFilterStatus('all')} className={`px-4 py-2 rounded-md text-sm font-bold transition-colors ${filterStatus === 'all' ? 'bg-blue-100 text-blue-700' : 'text-slate-500 hover:bg-slate-50'}`}>Todos</button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleExport} className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm shadow-sm transition-colors"><FileSpreadsheet className="w-4 h-4" /> Excel</button>
                                <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-bold text-sm shadow-sm transition-colors"><Printer className="w-4 h-4" /> PDF</button>
                            </div>
                            <div className="relative w-full md:w-64">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                                <input type="text" placeholder="Buscar lote..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            </div>
                        </div>

                        <div className="space-y-3">
                        {filteredBatches.length === 0 ? (
                            <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed border-slate-200">
                                <Package className="w-12 h-12 text-slate-300 mx-auto mb-3" />
                                <p className="text-slate-400 font-medium">Nenhum registro encontrado.</p>
                            </div>
                        ) : (
                            filteredBatches.map(batch => {
                                const isCritical = criticalBatches.find(c => c.id === batch.id);
                                return (
                                    <div key={batch.id} className={`relative bg-white p-4 rounded-xl shadow-sm border-l-4 transition-all hover:shadow-md flex flex-col md:flex-row items-center gap-4 print-shadow-none print-border 
                                        ${batch.status === 'pending' ? (isCritical ? 'border-l-red-800 bg-red-50' : 'border-l-red-500') : 
                                          batch.status === 'cancelled' ? 'border-l-gray-400 bg-gray-50 opacity-75' : 'border-l-green-500 opacity-90'}`}>
                                        <div className="flex-1 w-full">
                                            <div className="flex items-center flex-wrap gap-3 mb-2">
                                                <span className={`text-xl font-bold font-mono text-slate-800 tracking-wide ${batch.status === 'cancelled' ? 'line-through text-slate-500' : ''}`}>#{safeRender(batch.code)}</span>
                                                <span className={`text-xs px-2 py-1 rounded font-bold border ${batch.type === 'LM' ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-indigo-100 text-indigo-700 border-indigo-200'}`}>{safeRender(batch.type)}</span>
                                                {batch.status === 'pending' ? (
                                                    isCritical ? (
                                                        <span className="flex items-center gap-1 bg-red-800 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse print-hidden"><AlertTriangle className="w-3 h-3" /> ATRASADO</span>
                                                    ) : (
                                                        <span className="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full font-bold uppercase print-hidden">Pendente</span>
                                                    )
                                                ) : batch.status === 'cancelled' ? (
                                                    <span className="flex items-center gap-1 bg-gray-600 text-white text-xs px-2 py-1 rounded-full font-bold uppercase print-hidden"><XCircle className="w-3 h-3" /> Cancelado</span>
                                                ) : (
                                                    <span className="flex items-center gap-1 bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold uppercase print-hidden"><CheckCircle className="w-3 h-3" /> Expedido</span>
                                                )}
                                            </div>
                                            <div className="flex flex-wrap gap-x-6 gap-y-1 text-sm text-slate-500">
                                                <div className="flex items-center gap-1"><Clock className="w-3 h-3" /> <span className="font-semibold">Entrada:</span> {formatDate(batch.createdAt)}</div>
                                                {batch.dispatchedAt && (
                                                    <div className={`flex items-center gap-1 ${batch.status === 'cancelled' ? 'text-gray-500' : 'text-green-700'}`}>
                                                        <Truck className="w-3 h-3" />
                                                        <span className="font-semibold">{batch.status === 'cancelled' ? 'Cancelado:' : 'Saída:'}</span> {formatDate(batch.dispatchedAt)}
                                                    </div>
                                                )}
                                                {batch.dispatchedBy && (<div className="flex items-center gap-1 text-slate-700"><User className="w-3 h-3" /><span className="font-semibold">Resp:</span> {safeRender(batch.dispatchedBy)}</div>)}
                                            </div>
                                        </div>
                                        <div className="print-hidden flex items-center gap-2">
                                            {batch.status === 'pending' ? (
                                                <>
                                                    <button onClick={() => { setSelectedBatch(batch); setIsModalOpen(true); }} className={`px-6 py-2 rounded-lg font-bold text-white shadow-sm flex items-center gap-2 transition-transform active:scale-95 ${isCritical ? 'bg-red-700 hover:bg-red-800' : 'bg-green-600 hover:bg-green-700'}`}>
                                                        <Truck className="w-4 h-4" /> {isCritical ? 'RESOLVER' : 'EXPEDIR'}
                                                    </button>
                                                    <button onClick={() => handleCancel(batch)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="Cancelar Lote">
                                                        <XCircle className="w-6 h-6" />
                                                    </button>
                                                </>
                                            ) : (
                                                <button onClick={() => handleDelete(batch.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="Excluir"><Trash2 className="w-5 h-5" /></button>
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                        </div>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4 print-hidden transition-opacity duration-200">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Truck className="text-green-600 w-6 h-6" /> Confirmar Saída</h3>
                                <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600"><X className="w-6 h-6" /></button>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg mb-6 border border-slate-200 text-center">
                                <span className="text-xs uppercase font-bold text-slate-400 tracking-wider">Lote Selecionado</span>
                                <div className="text-3xl font-mono font-bold text-slate-800 mt-1">{safeRender(selectedBatch?.code)}</div>
                            </div>
                            <form onSubmit={handleDispatch}>
                                <div className="mb-6">
                                    <label className="block text-sm font-bold text-slate-700 mb-2">Nome do Responsável <span className="text-red-500">*</span></label>
                                    <input autoFocus required value={dispatcherName} onChange={e => setDispatcherName(e.target.value)} placeholder="DIGITE SEU NOME" className="w-full p-4 border-2 border-slate-300 rounded-lg focus:border-green-500 focus:outline-none text-center font-bold uppercase text-lg" />
                                </div>
                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-lg hover:bg-slate-200 transition-colors">CANCELAR</button>
                                    <button type="submit" disabled={!dispatcherName.trim() || isLoading} className="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-lg shadow-green-200 transition-colors disabled:opacity-50">CONFIRMAR</button>
                                </div>
                            </form>
                        </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
